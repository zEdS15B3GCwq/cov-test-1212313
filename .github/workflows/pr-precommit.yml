---
name: pre-commit PR check

on:  # yamllint disable-line rule:truthy
  pull_request:
    # types: [opened, synchronize]
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      is_fork: ${{ steps.check-fork.outputs.is_fork }}
      has_files: ${{ steps.changed.outputs.has_files }}
      changed_files: ${{ steps.changed.outputs.files }}
      is_bot: ${{ steps.check-bot.outputs.is_bot }}

    steps:
      - name: check if PR author is a bot
        id: check-bot
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;
            const isBot = author.includes('[bot]') || pr.user.type === 'Bot';
            core.setOutput("is_bot", isBot.toString());
            console.log(`PR author: ${author}, is bot: ${isBot}`);

      - name: check if PR is from a fork
        id: check-fork
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const isFork = pr.head.repo.full_name !== pr.base.repo.full_name;
            core.setOutput("is_fork", isFork.toString());
            console.log(`Is fork: ${isFork}`);

      - name: list changed files in PR
        id: changed
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
              }
            );
            const filenames = files
              .filter(f => f.status !== 'removed')  // Filter removed files
              .map(f => f.filename);
            console.log("Changed files:", filenames);

            const filesString = filenames.join('\n');
            core.setOutput("files", filesString);
            core.setOutput("has_files", filenames.length > 0 ? "true" : "false");

  precommit:
    name: |
      pre-commit checks on changed files (python ${{ matrix.python-version }} on ${{ matrix.os }})
    needs: prepare
    runs-on: ubuntu-latest
    if: |
      needs.prepare.outputs.is_fork == 'false' &&
      needs.prepare.outputs.has_files == 'true' &&
      needs.prepare.outputs.is_bot == 'false'
    permissions:
      contents: write
      pull-requests: write
    strategy:
      matrix:
        python-version: ["3.14"]
        os: [ubuntu-latest]

    steps:
      - name: checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: install uv
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3  # v7.1.3
        with:
          enable-cache: true

      - name: install pre-commit
        run: uv tool install pre-commit --with pre-commit-uv --python ${{ matrix.python-version }}
        shell: bash

      - name: cache pre-commit cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ github.workflow }}-${{ matrix.python-version }}-${{ hashFiles('.pre-commit-config.yaml') }}  # yamllint disable-line rule:line-length

      - name: run pre-commit on changed files
        id: run-precommit
        continue-on-error: true
        env:
          SKIP: nox-tests
          CHANGED_FILES: ${{ needs.prepare.outputs.changed_files }}
        run: |
          # Validate file exists and is not empty
          if [ -z "$CHANGED_FILES" ]; then
            echo "Error: no changed files"
            exit 1
          fi

          # xargs properly handles special characters and spaces
          echo "$CHANGED_FILES" | xargs -d '\n' \
            uvx pre-commit run \
              --show-diff-on-failure \
              --color=always \
              --files
        shell: bash

      - name: check for files modified by pre-commit
        if: steps.run-precommit.outcome == 'failure'
        id: modified
        run: |
          git_status=$(git status --porcelain)
          echo "Git status output:"
          echo "$git_status"

          if [ -n "$git_status" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Modified files detected by pre-commit"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No modifications made by pre-commit"
          fi
        shell: bash

      - name: commit and push fixes
        if: steps.modified.outputs.changes == 'true'
        shell: bash
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "Pre-commit made changes, committing and pushing..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.event.pull_request.head.repo.full_name }}.git"

          git add .
          git commit -m "[pre-commit] automatic fixes"
          git push origin "HEAD:refs/heads/${HEAD_REF}"
